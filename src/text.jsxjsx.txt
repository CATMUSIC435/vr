import { Canvas, useLoader } from '@react-three/fiber'
import { AdaptiveDpr, AdaptiveEvents, CameraControls, ContactShadows, Environment, Html, OrbitControls } from '@react-three/drei'
import { useRef, useState } from 'react'
// import PanoramaWithTransition from './panorama-with-transition';
import * as THREE from 'three';

export default function App() {

  const currentMeshRef = useRef();
  const currentTexture = useLoader(THREE.TextureLoader, '/assets/panorama.png')
  currentTexture.mapping = THREE.EquirectangularReflectionMapping;
  // currentTexture.encoding   = THREE.sRGBEncoding;
  currentTexture.generateMipmaps = false;
  // currentTexture.minFilter = THREE.LinearMipMapLinearFilter;
  const controls = useRef()
  const [transition, setTransition] = useState(0);

  const handleTransition = (e) => {
    const value = parseFloat(e.target.value);
    setTransition(value);
    
    if (controls.current) {
      controls.current.azimuthAngle = value * Math.PI * 2;
    }
  };

  return (
    <>
      <div className='relative h-screen w-screen overflow-hidden'>
        <div className='h-screen w-screen overflow-hidden'>
          <Canvas camera={{ position: [0, 0, 0.1] }}>
            <AdaptiveDpr pixelated />
            <AdaptiveEvents />
            <ambientLight intensity={Math.PI / 2} />
            <directionalLight
              position={[10, 10, 5]}
              intensity={1.5}
              castShadow
              shadow-mapSize-width={1024}
              shadow-mapSize-height={1024}
            />
            <mesh ref={currentMeshRef}>
              <sphereGeometry args={[500, 60, 40]} />
              <meshBasicMaterial map={currentTexture} side={THREE.BackSide} />
            </mesh>

            <mesh position={[0, 0, -500]}>
              {/* <sphereGeometry args={[2, 32, 32]} />
              <meshBasicMaterial color="red" /> */}
              <Html distanceFactor={10}>
                <div className='w-[10000px]'>
                  <img
                    className="w-full object-cover rounded-full"
                    src="https://atsaigonriverside.vn/wp-content/themes/dxmd/assets/images/dent.jpg"
                    alt="Beautiful House"
                  />
                </div>
              </Html>
            </mesh>

            <ambientLight intensity={0.5 * Math.PI} />
            <ContactShadows position={[0, -9, 0]} opacity={0.7} scale={40} blur={1} />
            <CameraControls ref={controls} enableZoom={true} minDistance={100} maxDistance={500} zoomSpeed={1.2} />
            <OrbitControls />
            <Environment preset="city" />
          </Canvas>
        </div>
        
        <div className='absolute bottom-8 left-1/2 transform -translate-x-1/2 w-80 bg-white/90 backdrop-blur-sm p-4 rounded-lg shadow-lg'>
          <label className='block text-sm font-medium text-gray-700 mb-2'>
            Chuyển cảnh
          </label>
          <input
            type="range"
            min="0"
            max="1"
            step="0.001"
            value={transition}
            onChange={handleTransition}
            className='w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider'
          />
          <div className='flex justify-between text-xs text-gray-600 mt-1'>
            <span>Bắt đầu</span>
            <span>{Math.round(transition * 100)}%</span>
            <span>Kết thúc</span>
          </div>
        </div>
      </div>
    </>
  )
}

